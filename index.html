<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarTraining.io</title>
    <!-- å¼•å…¥ Tone.js ç”¨äºéŸ³é¢‘ç”Ÿæˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --white-key-w: 24px;
            --white-key-h: 120px;
            --black-key-w: 14px;
            --black-key-h: 70px;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* è§†å›¾åˆ‡æ¢æ§åˆ¶ */
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: var(--bg); transition: opacity 0.3s; }
        .screen.active { display: flex; }

        h1 { color: #1f2937; margin-bottom: 2rem; }
        
        /* é€šç”¨æŒ‰é’® */
        .btn {
            padding: 12px 24px; margin: 10px; border: none; border-radius: 8px;
            font-size: 1rem; cursor: pointer; transition: 0.2s;
            background: white; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary); color: white; }

        /* é”®ç›˜å®¹å™¨ - æ”¯æŒæ¨ªå‘æ»šåŠ¨ */
        .piano-wrapper {
            width: 100%;
            overflow-x: auto;
            padding: 20px 0;
            background: #e5e7eb;
            display: flex;
            justify-content: center; /* é»˜è®¤å±…ä¸­ï¼Œå¦‚æœå¤ªå®½åˆ™é å·¦ */
        }
        
        .piano {
            position: relative;
            height: var(--white-key-h);
            user-select: none;
            display: flex;
            margin: 0 auto;
        }

        /* ç™½é”® */
        .key.white {
            width: var(--white-key-w);
            height: var(--white-key-h);
            background: white;
            border: 1px solid #ccc;
            border-radius: 0 0 4px 4px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            font-size: 10px;
            color: #999;
            padding-bottom: 4px;
            position: relative;
        }
        
        /* ç™½é”®æ ‡ç­¾ */
        .key.white .label-main { font-weight: bold; color: #333; margin-bottom: 2px; }
        .key.white .label-sub { font-size: 8px; color: #888; }

        /* é»‘é”® */
        .key.black {
            width: var(--black-key-w);
            height: var(--black-key-h);
            background: #1f2937;
            border-radius: 0 0 4px 4px;
            z-index: 2;
            position: absolute; /* ç»å¯¹å®šä½ï¼Œé€šè¿‡JSè®¡ç®— left */
            top: 0;
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .key.selected { background: #93c5fd !important; border-color: #60a5fa; }
        .key.black.selected { background: #3b82f6 !important; }
        
        /* æ‚¬åœçŠ¶æ€ */
        .key.white:hover { background: #e0f2fe !important; border-color: #93c5fd; }
        .key.black:hover { background: #60a5fa !important; }

        /* ç»ƒä¹ ç•Œé¢ */
        .controls { margin-top: 20px; text-align: center; }
        .feedback { height: 20px; margin-top: 10px; font-weight: bold; }
        .feedback.correct { color: green; }
        .feedback.wrong { color: red; }

        /* æç¤ºæ¡ */
        .info-bar { margin-bottom: 10px; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- 1. é¦–é¡µ -->
    <div id="home-screen" class="screen active">
        <h1>EarTraining.io</h1>
        <button class="btn btn-primary" onclick="goToSelection()">å¬éŸ³ç»ƒè€³</button>
        <button class="btn" onclick="alert('å†å²è®°å½•åŠŸèƒ½å¾…åç«¯æ¥å…¥')">å†å²è®°å½•</button>
    </div>

    <!-- 2. éŸ³åŸŸé€‰æ‹©é¡µ -->
    <div id="selection-screen" class="screen">
        <h2>é€‰æ‹©éŸ³åŸŸèŒƒå›´</h2>
        <div class="info-bar">ç‚¹å‡»é€‰æ‹©/å–æ¶ˆï¼Œé•¿æŒ‰æ‹–åŠ¨å¯æ‰¹é‡é€‰æ‹©</div>
        
        <div class="piano-wrapper">
            <div id="piano-selector" class="piano">
                <!-- ç´é”®å°†é€šè¿‡ JS ç”Ÿæˆ -->
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn" onclick="showScreen('home-screen')">è¿”å›</button>
            <button class="btn btn-primary" onclick="startTraining()">ç¡®è®¤å¼€å§‹</button>
        </div>
    </div>

    <!-- 3. ç»ƒä¹ é¡µ -->
    <div id="training-screen" class="screen">
        <h2>å¬éŸ³è¾¨éŸ³</h2>
        <div class="controls">
            <button class="btn btn-primary" onclick="playCurrentQuestion()">ğŸ”Š æ’­æ”¾/é‡æ’­</button>
        </div>
        <div id="feedback-msg" class="feedback"></div>
        <p class="info-bar">è¯·åœ¨ä¸‹æ–¹é”®ç›˜ä¸Šç‚¹å‡»å¬åˆ°çš„éŸ³</p>

        <div class="piano-wrapper">
            <div id="piano-practice" class="piano">
                <!-- å¤ç”¨ç”Ÿæˆé€»è¾‘ï¼Œç”Ÿæˆç»ƒä¹ é”®ç›˜ -->
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn" onclick="showScreen('selection-screen')">é‡æ–°é€‰æ‹©èŒƒå›´</button>
            <button class="btn" onclick="showScreen('home-screen')">è¿”å›é¦–é¡µ</button>
        </div>
    </div>

<script>
    // --- å…¨å±€é…ç½®ä¸çŠ¶æ€ ---
    // MIDI 21 (A0) åˆ° 108 (C8) æ˜¯æ ‡å‡†88é”®
    const START_MIDI = 21; 
    const END_MIDI = 108;
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const SOLFEGE = {'C':'Do', 'D':'Re', 'E':'Mi', 'F':'Fa', 'G':'Sol', 'A':'La', 'B':'Si'};
    
    let synth; // Tone.js åˆæˆå™¨
    let selectedNotes = new Set(); // å­˜å‚¨ç”¨æˆ·é€‰æ‹©çš„ MIDI éŸ³é«˜
    let currentTargetMidi = null; // å½“å‰é¢˜ç›®çš„éŸ³
    let isDragging = false;
    let dragAction = null; // 'add' or 'remove'
    
    // åˆå§‹åŒ– Tone.js åˆæˆå™¨
    async function initAudio() {
        if (!synth) {
            await Tone.start();
            synth = new Tone.PolySynth(Tone.Synth).toDestination();
            synth.set({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, release: 1 } });
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆé”®ç›˜ ---
    function generatePiano(containerId, isPracticeMode = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        let whiteKeyCount = 0;

        for (let midi = START_MIDI; midi <= END_MIDI; midi++) {
            const noteIndex = midi % 12;
            const octave = Math.floor(midi / 12) - 1;
            const noteName = NOTE_NAMES[noteIndex];
            const isBlack = noteName.includes('#');
            const noteFull = noteName + octave;

            const key = document.createElement('div');
            key.dataset.midi = midi;
            key.dataset.note = noteFull;
            
            // æ ·å¼å¤„ç†
            if (isBlack) {
                key.className = 'key black';
                // è®¡ç®—é»‘é”®ä½ç½®ï¼šä½äºå‰ä¸€ä¸ªç™½é”®çš„å³ä¾§åå·¦ä½ç½®
                // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„è¿‘ä¼¼å®šä½ï¼Œæ ‡å‡†é’¢ç´æ›´å¤æ‚
                let leftOffset = (whiteKeyCount * 24) - 7; // 24æ˜¯ç™½é”®å®½ï¼Œ7æ˜¯é»‘é”®å®½ä¸€åŠ
                key.style.left = leftOffset + 'px';
            } else {
                key.className = 'key white';
                // æ·»åŠ æ ‡ç­¾ (ä»…ç™½é”®)
                if (!isPracticeMode) { // ç»ƒä¹ æ¨¡å¼ä¹Ÿå¯ä»¥æ˜¾ç¤ºæ ‡ç­¾ï¼Œçœ‹éœ€æ±‚ï¼Œè¿™é‡Œé»˜è®¤éƒ½æ˜¾ç¤º
                   // é¡¶éƒ¨æ˜¾ç¤º A-G
                   const mainLabel = document.createElement('span');
                   mainLabel.className = 'label-main';
                   mainLabel.innerText = noteName;
                   // åº•éƒ¨æ˜¾ç¤º Do-Si
                   const subLabel = document.createElement('span');
                   subLabel.className = 'label-sub';
                   subLabel.innerText = SOLFEGE[noteName] || '';
                   key.appendChild(subLabel);
                   key.appendChild(mainLabel);
                }
                whiteKeyCount++;
            }

            // --- äº¤äº’äº‹ä»¶ç»‘å®š ---
            if (!isPracticeMode) {
                // é€‰æ‹©æ¨¡å¼ï¼šæ”¯æŒç‚¹å‡»å’Œæ‹–æ‹½
                key.addEventListener('mousedown', (e) => startDrag(midi, e));
                key.addEventListener('mouseenter', () => handleDrag(midi));
            } else {
                // ç»ƒä¹ æ¨¡å¼ï¼šç‚¹å‡»å›ç­”
                key.addEventListener('mousedown', () => submitAnswer(midi));
            }

            container.appendChild(key);
        }
        
        // è®¾ç½®å®¹å™¨æ€»å®½åº¦ï¼Œä¿è¯é»‘é”®èƒ½ç›¸å¯¹äºå®¹å™¨å®šä½
        container.style.width = (whiteKeyCount * 24) + 'px';
    }

    // --- é€‰æ‹©é¡µé€»è¾‘ï¼šæ‹–æ‹½é€‰æ‹© ---
    function startDrag(midi, e) {
        e.preventDefault(); // é˜²æ­¢æ–‡å­—é€‰ä¸­
        isDragging = true;
        // å†³å®šå½“å‰æ‹–æ‹½æ˜¯â€œé€‰ä¸­â€è¿˜æ˜¯â€œå–æ¶ˆé€‰ä¸­â€ï¼šå–å†³äºç¬¬ä¸€ä¸ªç‚¹å‡»çš„é”®çš„çŠ¶æ€
        const alreadySelected = selectedNotes.has(midi);
        dragAction = alreadySelected ? 'remove' : 'add';
        toggleSelection(midi, dragAction);
    }

    function handleDrag(midi) {
        if (isDragging) {
            toggleSelection(midi, dragAction);
        }
    }

    function endDrag() {
        isDragging = false;
        dragAction = null;
    }

    // åˆ‡æ¢å•ä¸ªé”®çš„é€‰ä¸­çŠ¶æ€
    function toggleSelection(midi, action) {
        const keyEl = document.querySelector(`#piano-selector .key[data-midi="${midi}"]`);
        
        if (action === 'add') {
            if (!selectedNotes.has(midi)) {
                selectedNotes.add(midi);
                keyEl.classList.add('selected');
                playNote(midi); // æ’­æ”¾éŸ³æ•ˆåé¦ˆ
            }
        } else {
            if (selectedNotes.has(midi)) {
                selectedNotes.delete(midi);
                keyEl.classList.remove('selected');
                playNote(midi); // æ’­æ”¾éŸ³æ•ˆåé¦ˆ
            }
        }
    }

    // å…¨å±€é¼ æ ‡æ¾å¼€ç›‘å¬ (å¤„ç†æ‹–æ‹½ç»“æŸ)
    window.addEventListener('mouseup', endDrag);

    // --- ç»ƒä¹ é¡µé€»è¾‘ ---
    function startTraining() {
        if (selectedNotes.size < 2) {
            alert("è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªéŸ³ç¬¦è¿›è¡Œç»ƒä¹ ï¼");
            return;
        }
        // åˆå§‹åŒ–ç»ƒä¹ é”®ç›˜
        generatePiano('piano-practice', true); // ç”Ÿæˆç»ƒä¹ ç”¨çš„é”®ç›˜
        showScreen('training-screen');
        nextQuestion();
    }

    function nextQuestion() {
        // ä» Set è½¬æ¢ Arrayï¼Œéšæœºå–ä¸€ä¸ª
        const notesArray = Array.from(selectedNotes);
        const randomIndex = Math.floor(Math.random() * notesArray.length);
        currentTargetMidi = notesArray[randomIndex];
        
        document.getElementById('feedback-msg').innerText = '';
        setTimeout(() => playCurrentQuestion(), 500);
    }

    function playCurrentQuestion() {
        if (currentTargetMidi && synth) {
            const noteName = Tone.Frequency(currentTargetMidi, "midi").toNote();
            synth.triggerAttackRelease(noteName, "8n");
        }
    }

    // æ’­æ”¾ä»»æ„éŸ³ï¼ˆç”¨äºé€‰æ‹©æ—¶çš„åé¦ˆï¼‰
    function playNote(midi) {
        if (synth) {
            const noteName = Tone.Frequency(midi, "midi").toNote();
            synth.triggerAttackRelease(noteName, "16n");
        }
    }

    function submitAnswer(userMidi) {
        // åªèƒ½ç‚¹å‡»åœ¨é€‰å®šèŒƒå›´å†…çš„éŸ³
        if (!selectedNotes.has(userMidi)) return; 

        playNote(userMidi); // æ’­æ”¾ç”¨æˆ·ç‚¹çš„éŸ³

        const feedbackEl = document.getElementById('feedback-msg');
        if (userMidi === currentTargetMidi) {
            feedbackEl.innerText = "æ­£ç¡®ï¼ğŸ‰";
            feedbackEl.className = "feedback correct";
            // TODO: è¿™é‡Œå°†æ¥è¦å‘é€ Ajax ç»™åç«¯è®°å½•æˆåŠŸ
            console.log(`Log: Correct identify ${userMidi}`);
            setTimeout(nextQuestion, 1000); // 1ç§’åä¸‹ä¸€é¢˜
        } else {
            feedbackEl.innerText = "é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚";
            feedbackEl.className = "feedback wrong";
            // TODO: è¿™é‡Œå°†æ¥è¦å‘é€ Ajax ç»™åç«¯è®°å½•å¤±è´¥ (Fa/La æ··æ·†é€»è¾‘åœ¨æ­¤å¤„è®°å½•)
            console.log(`Log: Mistook ${currentTargetMidi} for ${userMidi}`);
        }
    }

    // --- è§†å›¾è·¯ç”± ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function goToSelection() {
        await initAudio(); // ç”¨æˆ·ç‚¹å‡»ååˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        generatePiano('piano-selector');
        // æ¢å¤ä¹‹å‰çš„é€‰æ‹© (å¦‚æœæœ‰)
        selectedNotes.forEach(midi => {
            const el = document.querySelector(`#piano-selector .key[data-midi="${midi}"]`);
            if(el) el.classList.add('selected');
        });
        showScreen('selection-screen');
    }

</script>
</body>
</html>
