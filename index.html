<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarTraining.io</title>
    <!-- å¼•å…¥ Tone.js ç”¨äºéŸ³é¢‘ç”Ÿæˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --white-key-w: 24px;
            --white-key-h: 120px;
            --black-key-w: 14px;
            --black-key-h: 70px;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* è§†å›¾åˆ‡æ¢æ§åˆ¶ */
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: var(--bg); transition: opacity 0.3s; }
        .screen.active { display: flex; }

        h1 { color: #1f2937; margin-bottom: 2rem; }
        
        /* é€šç”¨æŒ‰é’® */
        .btn {
            padding: 12px 24px; margin: 10px; border: none; border-radius: 8px;
            font-size: 1rem; cursor: pointer; transition: 0.2s;
            background: white; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary); color: white; }

        /* é”®ç›˜å®¹å™¨ - æ”¯æŒæ¨ªå‘æ»šåŠ¨ */
        .piano-wrapper {
            width: 100%;
            overflow-x: auto;
            padding: 20px 0;
            background: #e5e7eb;
            display: flex;
            justify-content: center; /* é»˜è®¤å±…ä¸­ï¼Œå¦‚æœå¤ªå®½åˆ™é å·¦ */
        }
        
        .piano {
            position: relative;
            height: var(--white-key-h);
            user-select: none;
            display: flex;
            margin: 0 auto;
        }

        /* ç™½é”® */
        .key.white {
            width: var(--white-key-w);
            height: var(--white-key-h);
            background: white;
            border: 1px solid #ccc;
            border-radius: 0 0 4px 4px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            font-size: 10px;
            color: #999;
            padding-bottom: 4px;
            position: relative;
        }
        
        /* ç™½é”®æ ‡ç­¾ */
        .key.white .label-main { font-weight: bold; color: #333; margin-bottom: 2px; }
        .key.white .label-sub { font-size: 8px; color: #888; }

        /* é»‘é”® */
        .key.black {
            width: var(--black-key-w);
            height: var(--black-key-h);
            background: #1f2937;
            border-radius: 0 0 4px 4px;
            z-index: 2;
            position: absolute; /* ç»å¯¹å®šä½ï¼Œé€šè¿‡JSè®¡ç®— left */
            top: 0;
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .key.selected { background: #93c5fd !important; border-color: #60a5fa; }
        .key.black.selected { background: #3b82f6 !important; }
        
        /* æ‚¬åœçŠ¶æ€ */
        .key.white:hover { background: #e0f2fe !important; border-color: #93c5fd; }
        .key.black:hover { background: #60a5fa !important; }

        /* ç»ƒä¹ ç•Œé¢ */
        .controls { margin-top: 20px; text-align: center; }
        .feedback { height: 20px; margin-top: 10px; font-weight: bold; }
        .feedback.correct { color: green; }
        .feedback.wrong { color: red; }

        /* æç¤ºæ¡ */
        .info-bar { margin-bottom: 10px; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- 1. é¦–é¡µ -->
    <div id="home-screen" class="screen active">
        <h1>EarTraining.io</h1>
        <button class="btn btn-primary" onclick="goToSelection()">å¬éŸ³ç»ƒè€³</button>
        <button class="btn" onclick="showScreen('history-screen')">å†å²è®°å½•</button>
        <div style="margin-top: 40px;">
            <!-- æœªç™»å½•çŠ¶æ€æ˜¾ç¤º -->
            <div id="login-buttons">
                <button class="btn" onclick="showScreen('login-screen')">ç™»å½•</button>
                <button class="btn" onclick="showScreen('register-screen')">æ³¨å†Œ</button>
            </div>
            <!-- å·²ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
            <div id="user-info" style="display: none;">
                <span id="welcome-message" style="margin-right: 20px;"></span>
                <button class="btn" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>
    </div>

    <!-- 4. ç™»å½•é¡µ -->
    <div id="login-screen" class="screen">
        <h2>ç”¨æˆ·ç™»å½•</h2>
        <div style="width: 300px; text-align: left;">
            <div style="margin: 10px 0;">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="login-username" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc;">
            </div>
            <div style="margin: 10px 0;">
                <label>å¯†ç :</label>
                <input type="password" id="login-password" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc;">
            </div>
            <div id="login-error" style="color: red; margin: 10px 0;"></div>
        </div>
        <div style="margin-top: 20px;">
            <button class="btn" onclick="showScreen('home-screen')">è¿”å›</button>
            <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
        </div>
    </div>

    <!-- 5. æ³¨å†Œé¡µ -->
    <div id="register-screen" class="screen">
        <h2>ç”¨æˆ·æ³¨å†Œ</h2>
        <div style="width: 300px; text-align: left;">
            <div style="margin: 10px 0;">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="register-username" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc;">
            </div>
            <div style="margin: 10px 0;">
                <label>é‚®ç®±: (å¯é€‰)</label>
                <input type="email" id="register-email" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc;">
            </div>
            <div style="margin: 10px 0;">
                <label>å¯†ç :</label>
                <input type="password" id="register-password" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc;">
            </div>
            <div id="register-error" style="color: red; margin: 10px 0;"></div>
        </div>
        <div style="margin-top: 20px;">
            <button class="btn" onclick="showScreen('home-screen')">è¿”å›</button>
            <button class="btn btn-primary" onclick="register()">æ³¨å†Œ</button>
        </div>
    </div>

    <!-- 6. å†å²è®°å½•é¡µ -->
    <div id="history-screen" class="screen">
        <div style="position: sticky; top: 10px; z-index: 10; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">ç»ƒä¹ å†å²</h2>
            <button class="btn" onclick="showScreen('home-screen')">è¿”å›ä¸»é¡µ</button>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 20px; width: 90%; max-width: 1000px;">
            <!-- ä¼šè¯åˆ—è¡¨ -->
            <div style="flex: 1; min-width: 300px; max-width: 400px;">
                <h3>ç»ƒä¹ ä¼šè¯</h3>
                <div id="session-list" style="max-height: 600px; overflow-y: auto; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                    <!-- ä¼šè¯åˆ—è¡¨å°†é€šè¿‡JSåŠ è½½ -->
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
            <!-- ç­”é¢˜è®°å½•è¯¦æƒ… -->
            <div style="flex: 1; min-width: 300px; max-width: 500px;">
                <h3>ç­”é¢˜è¯¦æƒ…</h3>
                <div id="session-details" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                    <p>è¯·é€‰æ‹©ä¸€ä¸ªç»ƒä¹ ä¼šè¯æŸ¥çœ‹è¯¦æƒ…</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. éŸ³åŸŸé€‰æ‹©é¡µ -->
    <div id="selection-screen" class="screen">
        <h2>é€‰æ‹©éŸ³åŸŸèŒƒå›´</h2>
        <div class="info-bar">ç‚¹å‡»é€‰æ‹©/å–æ¶ˆï¼Œé•¿æŒ‰æ‹–åŠ¨å¯æ‰¹é‡é€‰æ‹©</div>
        
        <div class="piano-wrapper">
            <div id="piano-selector" class="piano">
                <!-- ç´é”®å°†é€šè¿‡ JS ç”Ÿæˆ -->
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn" onclick="showScreen('home-screen')">è¿”å›</button>
            <button class="btn btn-primary" onclick="startTraining()">ç¡®è®¤å¼€å§‹</button>
        </div>
    </div>

    <!-- 3. ç»ƒä¹ é¡µ -->
    <div id="training-screen" class="screen">
        <h2>å¬éŸ³è¾¨éŸ³</h2>
        <div class="controls">
            <button class="btn btn-primary" onclick="playCurrentQuestion()">ğŸ”Š æ’­æ”¾/é‡æ’­</button>
        </div>
        <div id="feedback-msg" class="feedback"></div>
        <p class="info-bar">è¯·åœ¨ä¸‹æ–¹é”®ç›˜ä¸Šç‚¹å‡»å¬åˆ°çš„éŸ³</p>

        <div class="piano-wrapper">
            <div id="piano-practice" class="piano">
                <!-- å¤ç”¨ç”Ÿæˆé€»è¾‘ï¼Œç”Ÿæˆç»ƒä¹ é”®ç›˜ -->
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn" onclick="showScreen('selection-screen')">é‡æ–°é€‰æ‹©èŒƒå›´</button>
            <button class="btn" onclick="showScreen('home-screen')">è¿”å›é¦–é¡µ</button>
        </div>
    </div>

<script>
    // --- å…¨å±€é…ç½®ä¸çŠ¶æ€ ---
    // MIDI 21 (A0) åˆ° 108 (C8) æ˜¯æ ‡å‡†88é”®
    const START_MIDI = 21; 
    const END_MIDI = 108;
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const SOLFEGE = {'C':'Do', 'D':'Re', 'E':'Mi', 'F':'Fa', 'G':'Sol', 'A':'La', 'B':'Si'};
    const API_BASE_URL = 'http://localhost:8000';
    
    let synth; // Tone.js åˆæˆå™¨
    let selectedNotes = new Set(); // å­˜å‚¨ç”¨æˆ·é€‰æ‹©çš„ MIDI éŸ³é«˜
    let currentTargetMidi = null; // å½“å‰é¢˜ç›®çš„éŸ³
    let isDragging = false;
    let dragAction = null; // 'add' or 'remove'
    let currentSessionId = null; // å½“å‰ç»ƒä¹ ä¼šè¯ID
    let authToken = localStorage.getItem('auth_token'); // è®¤è¯ä»¤ç‰Œ
    let userId = localStorage.getItem('user_id'); // ç”¨æˆ·ID
    let username = localStorage.getItem('username'); // ç”¨æˆ·å
    let lastActivityTime = Date.now(); // æœ€åæ´»åŠ¨æ—¶é—´
    let inactivityTimer = null; // æ— æ´»åŠ¨è®¡æ—¶å™¨
    
    // æ›´æ–°æ´»åŠ¨æ—¶é—´
    function updateActivityTime() {
        lastActivityTime = Date.now();
    }
    
    // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
    function checkInactivity() {
        const currentTime = Date.now();
        const inactivityTime = (currentTime - lastActivityTime) / 1000; // è½¬æ¢ä¸ºç§’
        
        if (inactivityTime >= 60 && currentSessionId) { // 60ç§’æ— æ´»åŠ¨ä¸”æœ‰æ´»è·ƒä¼šè¯
            endPracticeSession();
            alert('ç»ƒä¹ å·²è‡ªåŠ¨ä¸­æ­¢ï¼ˆè¶…è¿‡1åˆ†é’Ÿæ— å“åº”ï¼‰');
        } else if (currentSessionId) {
            // ç»§ç»­æ£€æµ‹
            inactivityTimer = setTimeout(checkInactivity, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ›´æ–°ç”¨æˆ·çŠ¶æ€
    window.onload = function() {
        updateUserStatus();
        
        // æ·»åŠ æ´»åŠ¨ç›‘å¬å™¨
        document.addEventListener('click', updateActivityTime);
        document.addEventListener('keydown', updateActivityTime);
        document.addEventListener('mousemove', updateActivityTime);
        document.addEventListener('touchstart', updateActivityTime);
    };
    
    // åˆå§‹åŒ– Tone.js åˆæˆå™¨
    async function initAudio() {
        if (!synth) {
            await Tone.start();
            synth = new Tone.PolySynth(Tone.Synth).toDestination();
            synth.set({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, release: 1 } });
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆé”®ç›˜ ---
    function generatePiano(containerId, isPracticeMode = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        let whiteKeyCount = 0;

        for (let midi = START_MIDI; midi <= END_MIDI; midi++) {
            const noteIndex = midi % 12;
            const octave = Math.floor(midi / 12) - 1;
            const noteName = NOTE_NAMES[noteIndex];
            const isBlack = noteName.includes('#');
            const noteFull = noteName + octave;

            const key = document.createElement('div');
            key.dataset.midi = midi;
            key.dataset.note = noteFull;
            
            // æ ·å¼å¤„ç†
            if (isBlack) {
                key.className = 'key black';
                // è®¡ç®—é»‘é”®ä½ç½®ï¼šä½äºå‰ä¸€ä¸ªç™½é”®çš„å³ä¾§åå·¦ä½ç½®
                // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„è¿‘ä¼¼å®šä½ï¼Œæ ‡å‡†é’¢ç´æ›´å¤æ‚
                let leftOffset = (whiteKeyCount * 24) - 7; // 24æ˜¯ç™½é”®å®½ï¼Œ7æ˜¯é»‘é”®å®½ä¸€åŠ
                key.style.left = leftOffset + 'px';
            } else {
                key.className = 'key white';
                // æ·»åŠ æ ‡ç­¾ (ä»…ç™½é”®)
                // é¡¶éƒ¨æ˜¾ç¤º A-G
                const mainLabel = document.createElement('span');
                mainLabel.className = 'label-main';
                mainLabel.innerText = noteName;
                // åº•éƒ¨æ˜¾ç¤º Do-Si
                const subLabel = document.createElement('span');
                subLabel.className = 'label-sub';
                subLabel.innerText = SOLFEGE[noteName] || '';
                key.appendChild(subLabel);
                key.appendChild(mainLabel);
                whiteKeyCount++;
            }

            // --- äº¤äº’äº‹ä»¶ç»‘å®š ---
            if (!isPracticeMode) {
                // é€‰æ‹©æ¨¡å¼ï¼šæ”¯æŒç‚¹å‡»å’Œæ‹–æ‹½
                key.addEventListener('mousedown', (e) => startDrag(midi, e));
                key.addEventListener('mouseenter', () => handleDrag(midi));
            } else {
                // ç»ƒä¹ æ¨¡å¼ï¼šç‚¹å‡»å›ç­”
                key.addEventListener('mousedown', () => submitAnswer(midi));
            }

            container.appendChild(key);
        }
        
        // è®¾ç½®å®¹å™¨æ€»å®½åº¦ï¼Œä¿è¯é»‘é”®èƒ½ç›¸å¯¹äºå®¹å™¨å®šä½
        container.style.width = (whiteKeyCount * 24) + 'px';
    }

    // --- é€‰æ‹©é¡µé€»è¾‘ï¼šæ‹–æ‹½é€‰æ‹© ---
    function startDrag(midi, e) {
        e.preventDefault(); // é˜²æ­¢æ–‡å­—é€‰ä¸­
        isDragging = true;
        // å†³å®šå½“å‰æ‹–æ‹½æ˜¯â€œé€‰ä¸­â€è¿˜æ˜¯â€œå–æ¶ˆé€‰ä¸­â€ï¼šå–å†³äºç¬¬ä¸€ä¸ªç‚¹å‡»çš„é”®çš„çŠ¶æ€
        const alreadySelected = selectedNotes.has(midi);
        dragAction = alreadySelected ? 'remove' : 'add';
        toggleSelection(midi, dragAction);
    }

    function handleDrag(midi) {
        if (isDragging) {
            toggleSelection(midi, dragAction);
        }
    }

    function endDrag() {
        isDragging = false;
        dragAction = null;
    }

    // åˆ‡æ¢å•ä¸ªé”®çš„é€‰ä¸­çŠ¶æ€
    function toggleSelection(midi, action) {
        const keyEl = document.querySelector(`#piano-selector .key[data-midi="${midi}"]`);
        
        if (action === 'add') {
            if (!selectedNotes.has(midi)) {
                selectedNotes.add(midi);
                keyEl.classList.add('selected');
                playNote(midi); // æ’­æ”¾éŸ³æ•ˆåé¦ˆ
            }
        } else {
            if (selectedNotes.has(midi)) {
                selectedNotes.delete(midi);
                keyEl.classList.remove('selected');
                playNote(midi); // æ’­æ”¾éŸ³æ•ˆåé¦ˆ
            }
        }
    }

    // å…¨å±€é¼ æ ‡æ¾å¼€ç›‘å¬ (å¤„ç†æ‹–æ‹½ç»“æŸ)
    window.addEventListener('mouseup', endDrag);

    // --- ç»ƒä¹ é¡µé€»è¾‘ ---
    function startTraining() {
        if (selectedNotes.size < 2) {
            alert("è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªéŸ³ç¬¦è¿›è¡Œç»ƒä¹ ï¼");
            return;
        }
        // åˆå§‹åŒ–ç»ƒä¹ é”®ç›˜
        generatePiano('piano-practice', true); // ç”Ÿæˆç»ƒä¹ ç”¨çš„é”®ç›˜
        showScreen('training-screen');
        nextQuestion();
    }

    function nextQuestion() {
        // ä» Set è½¬æ¢ Arrayï¼Œéšæœºå–ä¸€ä¸ª
        const notesArray = Array.from(selectedNotes);
        const randomIndex = Math.floor(Math.random() * notesArray.length);
        currentTargetMidi = notesArray[randomIndex];
        
        document.getElementById('feedback-msg').innerText = '';
        setTimeout(() => playCurrentQuestion(), 500);
    }

    function playCurrentQuestion() {
        if (currentTargetMidi && synth) {
            const noteName = Tone.Frequency(currentTargetMidi, "midi").toNote();
            synth.triggerAttackRelease(noteName, "8n");
        }
    }

    // æ’­æ”¾ä»»æ„éŸ³ï¼ˆç”¨äºé€‰æ‹©æ—¶çš„åé¦ˆï¼‰
    function playNote(midi) {
        if (synth) {
            const noteName = Tone.Frequency(midi, "midi").toNote();
            synth.triggerAttackRelease(noteName, "16n");
        }
    }

    function submitAnswer(userMidi) {
        // åªèƒ½ç‚¹å‡»åœ¨é€‰å®šèŒƒå›´å†…çš„éŸ³
        if (!selectedNotes.has(userMidi)) return; 

        playNote(userMidi); // æ’­æ”¾ç”¨æˆ·ç‚¹çš„éŸ³

        const feedbackEl = document.getElementById('feedback-msg');
        if (userMidi === currentTargetMidi) {
            feedbackEl.innerText = "æ­£ç¡®ï¼ğŸ‰";
            feedbackEl.className = "feedback correct";
            // TODO: è¿™é‡Œå°†æ¥è¦å‘é€ Ajax ç»™åç«¯è®°å½•æˆåŠŸ
            console.log(`Log: Correct identify ${userMidi}`);
            setTimeout(nextQuestion, 1000); // 1ç§’åä¸‹ä¸€é¢˜
        } else {
            feedbackEl.innerText = "é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚";
            feedbackEl.className = "feedback wrong";
            // TODO: è¿™é‡Œå°†æ¥è¦å‘é€ Ajax ç»™åç«¯è®°å½•å¤±è´¥ (Fa/La æ··æ·†é€»è¾‘åœ¨æ­¤å¤„è®°å½•)
            console.log(`Log: Mistook ${currentTargetMidi} for ${userMidi}`);
        }
    }

    // --- API è°ƒç”¨å‡½æ•° ---
    async function apiCall(endpoint, method = 'GET', data = null) {
        const url = `${API_BASE_URL}${endpoint}`;
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
            },
        };
        
        if (authToken) {
            options.headers['Authorization'] = `Token ${authToken}`;
        }
        
        if (data && (method === 'POST' || method === 'PUT')) {
            options.body = JSON.stringify(data);
        }
        
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('API call failed:', error);
            throw error;
        }
    }

    // --- ç”¨æˆ·è®¤è¯å‡½æ•° ---
    async function login() {
        const loginUsername = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');
        
        try {
            const response = await apiCall('/api/training/login/', 'POST', {
                username: loginUsername,
                password
            });
            
            // ä¿å­˜è®¤è¯ä¿¡æ¯
            authToken = response.token;
            userId = response.user_id;
            username = response.username;
            
            localStorage.setItem('auth_token', authToken);
            localStorage.setItem('user_id', userId);
            localStorage.setItem('username', username);
            
            updateUserStatus();
            showScreen('home-screen');
        } catch (error) {
            errorEl.innerText = 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
        }
    }

    async function register() {
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const errorEl = document.getElementById('register-error');
        
        try {
            // æ„å»ºæ³¨å†Œæ•°æ®ï¼Œé‚®ç®±å¯é€‰
            const registerData = {
                username,
                password
            };
            
            // å¦‚æœç”¨æˆ·è¾“å…¥äº†é‚®ç®±ï¼Œæ‰æ·»åŠ åˆ°æ•°æ®ä¸­
            if (email.trim()) {
                registerData.email = email;
            }
            
            await apiCall('/api/training/register/', 'POST', registerData);
            
            // æ³¨å†ŒæˆåŠŸåè·³è½¬åˆ°ç™»å½•é¡µ
            showScreen('login-screen');
        } catch (error) {
            errorEl.innerText = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯';
        }
    }

    async function loadHistory() {
        const sessionListEl = document.getElementById('session-list');
        const sessionDetailsEl = document.getElementById('session-details');
        
        if (!authToken) {
            sessionListEl.innerHTML = '<p>è¯·å…ˆç™»å½•æŸ¥çœ‹å†å²è®°å½•</p>';
            sessionDetailsEl.innerHTML = '<p>è¯·å…ˆç™»å½•æŸ¥çœ‹å†å²è®°å½•</p>';
            return;
        }
        
        try {
            const sessions = await apiCall('/api/training/sessions/');
            
            if (sessions.length === 0) {
                sessionListEl.innerHTML = '<p>æš‚æ— ç»ƒä¹ å†å²</p>';
                sessionDetailsEl.innerHTML = '<p>æš‚æ— ç»ƒä¹ å†å²</p>';
                return;
            }
            
            // æ˜¾ç¤ºä¼šè¯åˆ—è¡¨
            let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
            
            sessions.forEach(session => {
                const endTime = session.end_time ? new Date(session.end_time).toLocaleString() : 'è¿›è¡Œä¸­';
                const accuracy = session.total_count > 0 ? Math.round((session.correct_count / session.total_count) * 100) : 0;
                
                html += `<li style="margin: 8px 0; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" onclick="loadSessionDetails(${session.id})"><strong>å¼€å§‹æ—¶é—´:</strong> ${new Date(session.start_time).toLocaleString()}<br><strong>ç»“æŸæ—¶é—´:</strong> ${endTime}<br><strong>æ­£ç¡®ç‡:</strong> ${session.correct_count}/${session.total_count} (${accuracy}%)</li>`;
            });
            
            html += '</ul>';
            
            sessionListEl.innerHTML = html;
        } catch (error) {
            sessionListEl.innerHTML = '<p>åŠ è½½å†å²è®°å½•å¤±è´¥</p>';
            sessionDetailsEl.innerHTML = '<p>åŠ è½½å†å²è®°å½•å¤±è´¥</p>';
        }
    }
    
    async function loadSessionDetails(sessionId) {
        const sessionDetailsEl = document.getElementById('session-details');
        
        try {
            // è·å–æ‰€æœ‰ä¼šè¯ä¿¡æ¯ï¼Œæ‰¾åˆ°è¢«ç‚¹å‡»çš„ä¼šè¯
            const sessions = await apiCall('/api/training/sessions/');
            const targetSession = sessions.find(session => session.id === sessionId);
            
            if (!targetSession) {
                sessionDetailsEl.innerHTML = '<p>ä¼šè¯ä¸å­˜åœ¨</p>';
                return;
            }
            
            // è·å–æ‰€æœ‰ç­”é¢˜è®°å½•
            const records = await apiCall('/api/training/answers/');
            
            sessionDetailsEl.innerHTML = '<p>åŠ è½½ä¸­...</p>';
            
            // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
            setTimeout(() => {
                // ç­›é€‰å‡ºè¯¥ä¼šè¯æ—¶é—´èŒƒå›´å†…çš„è®°å½•
                const sessionStartTime = new Date(targetSession.start_time);
                const sessionEndTime = targetSession.end_time ? new Date(targetSession.end_time) : new Date();
                
                const sessionRecords = records.filter(record => {
                    const recordTime = new Date(record.created_at);
                    return recordTime >= sessionStartTime && recordTime <= sessionEndTime;
                });
                
                if (sessionRecords.length === 0) {
                    sessionDetailsEl.innerHTML = '<p>è¯¥ä¼šè¯æš‚æ— ç­”é¢˜è®°å½•</p>';
                    return;
                }
                
                let html = '<ul style="list-style: none; padding: 0; margin: 0; max-height: 500px; overflow-y: auto;">';
                
                sessionRecords.forEach(record => {
                    const targetNote = NOTE_NAMES[record.target_midi % 12] + Math.floor(record.target_midi / 12) - 1;
                    const userNote = NOTE_NAMES[record.user_answer % 12] + Math.floor(record.user_answer / 12) - 1;
                    
                    html += `<li style="margin: 6px 0; padding: 10px; background: ${record.is_correct ? '#dcfce7' : '#fee2e2'}; border-radius: 6px;"><strong>æ—¶é—´:</strong> ${new Date(record.created_at).toLocaleString()}<br><strong>ç›®æ ‡éŸ³ç¬¦:</strong> ${targetNote}<br><strong>ä½ çš„ç­”æ¡ˆ:</strong> ${userNote}<br><strong>ç»“æœ:</strong> ${record.is_correct ? 'æ­£ç¡®' : 'é”™è¯¯'}</li>`;
                });
                
                html += '</ul>';
                
                sessionDetailsEl.innerHTML = html;
            }, 500);
        } catch (error) {
            sessionDetailsEl.innerHTML = '<p>åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥</p>';
        }
    }

    // --- ç”¨æˆ·çŠ¶æ€ç®¡ç† ---
    function updateUserStatus() {
        const loginButtons = document.getElementById('login-buttons');
        const userInfo = document.getElementById('user-info');
        const welcomeMessage = document.getElementById('welcome-message');
        
        if (authToken && username) {
            // å·²ç™»å½•çŠ¶æ€
            loginButtons.style.display = 'none';
            userInfo.style.display = 'block';
            welcomeMessage.innerText = `æ¬¢è¿ï¼Œ${username}ï¼`;
        } else {
            // æœªç™»å½•çŠ¶æ€
            loginButtons.style.display = 'block';
            userInfo.style.display = 'none';
        }
    }
    
    function logout() {
        // æ¸…é™¤è®¤è¯ä¿¡æ¯
        authToken = null;
        userId = null;
        username = null;
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_id');
        localStorage.removeItem('username');
        
        // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
        updateUserStatus();
        
        // æ˜¾ç¤ºç™»å½•æˆåŠŸæç¤º
        alert('å·²æˆåŠŸç™»å‡º');
    }
    
    // --- ç»ƒä¹ ä¼šè¯ç®¡ç† ---
    async function startPracticeSession() {
        if (!authToken) return;
        
        try {
            const session = await apiCall('/api/training/sessions/', 'POST', {
                correct_count: 0,
                total_count: 0
            });
            currentSessionId = session.id;
            
            // å¯åŠ¨è¶…æ—¶æ£€æµ‹
            updateActivityTime();
            checkInactivity();
        } catch (error) {
            console.error('Failed to start practice session:', error);
        }
    }

    async function updatePracticeSession(correct) {
        if (!authToken || !currentSessionId) return;
        
        try {
            const session = await apiCall(`/api/training/sessions/`, 'GET');
            const currentSession = session.find(s => s.id === currentSessionId);
            
            if (currentSession) {
                await apiCall('/api/training/sessions/', 'POST', {
                    id: currentSessionId,
                    correct_count: currentSession.correct_count + (correct ? 1 : 0),
                    total_count: currentSession.total_count + 1
                });
            }
        } catch (error) {
            console.error('Failed to update practice session:', error);
        }
    }
    
    async function endPracticeSession() {
        if (!authToken || !currentSessionId) return;
        
        try {
            // æ›´æ–°ä¼šè¯ï¼Œæ·»åŠ ç»“æŸæ—¶é—´
            await apiCall('/api/training/sessions/', 'POST', {
                id: currentSessionId,
                end_time: new Date().toISOString()
            });
            
            // é‡ç½®ä¼šè¯ID
            currentSessionId = null;
            
            // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
            
            // é€šçŸ¥ç”¨æˆ·ç»ƒä¹ å·²ç»“æŸ
            alert('ç»ƒä¹ å·²ä¸­æ­¢');
        } catch (error) {
            console.error('Failed to end practice session:', error);
        }
    }

    // --- ç­”é¢˜ç»“æœæäº¤ ---
    function submitAnswer(userMidi) {
        // åªèƒ½ç‚¹å‡»åœ¨é€‰å®šèŒƒå›´å†…çš„éŸ³
        if (!selectedNotes.has(userMidi)) return; 

        playNote(userMidi); // æ’­æ”¾ç”¨æˆ·ç‚¹çš„éŸ³

        const feedbackEl = document.getElementById('feedback-msg');
        const isCorrect = userMidi === currentTargetMidi;
        
        if (isCorrect) {
            feedbackEl.innerText = "æ­£ç¡®ï¼ğŸ‰";
            feedbackEl.className = "feedback correct";
            // å‘é€ç­”é¢˜ç»“æœåˆ°åç«¯
            if (authToken) {
                console.log('Sending answer with currentSessionId:', currentSessionId);
                apiCall('/api/training/answers/', 'POST', {
                    target_midi: currentTargetMidi,
                    user_answer: userMidi,
                    is_correct: true,
                    sessionId: currentSessionId
                }).catch(error => console.error('Failed to send answer:', error));
                
                console.log('API call completed for correct answer');
                updatePracticeSession(true);
            } else {
                console.log('No authToken, not sending answer');
            }
            setTimeout(nextQuestion, 1000); // 1ç§’åä¸‹ä¸€é¢˜
        } else {
            feedbackEl.innerText = "é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚";
            feedbackEl.className = "feedback wrong";
            // å‘é€ç­”é¢˜ç»“æœåˆ°åç«¯
            if (authToken) {
                console.log('Sending answer with currentSessionId:', currentSessionId);
                apiCall('/api/training/answers/', 'POST', {
                    target_midi: currentTargetMidi,
                    user_answer: userMidi,
                    is_correct: false,
                    sessionId: currentSessionId
                }).catch(error => console.error('Failed to send answer:', error));
                
                console.log('API call completed for wrong answer');
                updatePracticeSession(false);
            } else {
                console.log('No authToken, not sending answer');
            }
        }
    }

    // --- è§†å›¾è·¯ç”± ---  
    function showScreen(id) {
        // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨ç»ƒä¹ é¡µï¼Œå¦‚æœæ˜¯åˆ™ç»“æŸä¼šè¯
        const currentScreen = document.querySelector('.screen.active');
        if (currentScreen && currentScreen.id === 'training-screen' && id !== 'training-screen') {
            endPracticeSession();
        }
        
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•é¡µï¼ŒåŠ è½½å†å²è®°å½•
        if (id === 'history-screen') {
            loadHistory();
        }
    }

    async function goToSelection() {
        await initAudio(); // ç”¨æˆ·ç‚¹å‡»ååˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        generatePiano('piano-selector');
        // æ¢å¤ä¹‹å‰çš„é€‰æ‹© (å¦‚æœæœ‰)
        selectedNotes.forEach(midi => {
            const el = document.querySelector(`#piano-selector .key[data-midi="${midi}"]`);
            if(el) el.classList.add('selected');
        });
        showScreen('selection-screen');
    }

    // ä¿®æ”¹ startTraining å‡½æ•°ï¼Œæ·»åŠ ç»ƒä¹ ä¼šè¯å¼€å§‹
    async function startTraining() {
        if (selectedNotes.size < 2) {
            alert("è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªéŸ³ç¬¦è¿›è¡Œç»ƒä¹ ï¼");
            return;
        }
        // åˆå§‹åŒ–ç»ƒä¹ é”®ç›˜
        generatePiano('piano-practice', true); // ç”Ÿæˆç»ƒä¹ ç”¨çš„é”®ç›˜
        showScreen('training-screen');
        // å¼€å§‹ç»ƒä¹ ä¼šè¯
        await startPracticeSession();
        console.log('Current session ID after start:', currentSessionId);
        nextQuestion();
    }

</script>
</body>
</html>
